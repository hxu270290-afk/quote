<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Iceberg 3D ‚Äì Custom 3D Printing Quote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Three.js ÂèäÊèí‰ª∂ÔºàÁî®‰∫é STL È¢ÑËßàÔºâ -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/three@0.158.0/examples/js/loaders/STLLoader.js"></script>
  <style>
    :root {
      --bg: #050816;
      --card-bg: #0b1020;
      --card-soft: #101528;
      --accent: #4f9cff;
      --accent-soft: rgba(79, 156, 255, 0.12);
      --text-main: #f5f5f7;
      --text-muted: #a0a3b1;
      --border-subtle: rgba(255, 255, 255, 0.08);
      --radius-lg: 18px;
      --danger: #ff6b81;
      --success: #33ff99;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #151b3b 0, #050816 55%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    @media (max-width: 900px) {
      body {
        padding: 12px;
      }
    }

    .page {
      width: 100%;
      max-width: 1220px;
    }

    /* È°∂ÈÉ®ÊèêÁ§∫Êù° */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 7px 14px;
      border-radius: 999px;
      background: rgba(10, 15, 40, 0.92);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
      margin-bottom: 14px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .top-bar-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--success);
      box-shadow: 0 0 0 4px rgba(51, 255, 153, 0.3);
    }

    .tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
    }

    header h1 {
      margin: 6px 0 4px;
      font-size: 26px;
      letter-spacing: 0.04em;
    }

    header p {
      margin: 0 0 16px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .main-card {
      background: linear-gradient(
            135deg,
            rgba(151, 201, 255, 0.09) 0,
            transparent 45%
          ),
        radial-gradient(circle at top right, rgba(35, 88, 255, 0.3) 0, transparent 55%),
        var(--card-bg);
      border-radius: 24px;
      padding: 18px 18px 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(16px);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 3.2fr) minmax(0, 2.5fr);
      gap: 18px;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .section-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .section-label span.icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--accent);
    }

    h2 {
      margin: 0 0 8px;
      font-size: 17px;
    }

    .sub-text {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    /* ‰∏ä‰º†Âå∫ */
    .upload-card {
      background: var(--card-soft);
      border-radius: 16px;
      padding: 12px;
      border: 1px dashed rgba(255, 255, 255, 0.18);
      margin-bottom: 14px;
      transition: border 0.15s ease, background 0.15s ease;
    }

    .upload-card.dragover {
      border-color: var(--accent);
      background: rgba(15, 24, 56, 0.9);
    }

    .upload-inner {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }

    .upload-icon {
      width: 42px;
      height: 42px;
      border-radius: 16px;
      background: radial-gradient(circle at top, #4f9cff 0, #0b1020 68%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .upload-text-main {
      font-size: 13px;
      font-weight: 500;
    }

    .upload-text-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .badge-filetypes {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: #d3e0ff;
      margin-top: 4px;
      display: inline-flex;
      gap: 3px;
      align-items: center;
    }

    .file-list {
      margin-top: 10px;
      max-height: 150px;
      overflow: auto;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      padding-top: 6px;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
      padding: 4px 0;
    }

    .file-main {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .file-badge {
      width: 22px;
      height: 22px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: var(--accent);
    }

    .file-meta {
      color: var(--text-muted);
      font-size: 11px;
    }

    .file-remove {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
    }

    /* Ë°®ÂçïÂÖÉÁ¥† */
    .field-group {
      margin-bottom: 10px;
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    label {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .label-main {
      color: var(--text-main);
      font-weight: 500;
      font-size: 13px;
    }

    input[type="number"],
    input[type="text"],
    input[type="email"],
    select,
    textarea {
      width: 100%;
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: rgba(7, 10, 25, 0.96);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    input::placeholder,
    textarea::placeholder {
      color: rgba(160, 163, 177, 0.8);
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(79, 156, 255, 0.5);
      background: rgba(7, 10, 25, 1);
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* Âç°ÁâáÁ±ªÂà´ */
    .segmented-control {
      display: inline-flex;
      padding: 2px;
      border-radius: 999px;
      background: rgba(15, 21, 46, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.08);
      margin-bottom: 8px;
    }

    .segmented-option {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      cursor: pointer;
      color: var(--text-muted);
      user-select: none;
    }

    .segmented-option.active {
      background: var(--accent);
      color: #050816;
      font-weight: 500;
    }

    .material-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 8px;
    }

    .material-card {
      border-radius: 12px;
      padding: 8px 9px;
      background: rgba(10, 15, 40, 0.96);
      border: 1px solid rgba(255, 255, 255, 0.08);
      cursor: pointer;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease,
        transform 0.12s ease;
      font-size: 12px;
    }

    .material-card:hover {
      border-color: var(--accent);
      background: rgba(15, 24, 56, 0.96);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
      transform: translateY(-1px);
    }

    .material-card.active {
      border-color: var(--accent);
      box-shadow: 0 8px 28px rgba(79, 156, 255, 0.35);
    }

    .material-name {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }

    .material-pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
      color: #e7e8ff;
    }

    .material-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .badge-strong {
      font-size: 10px;
      color: #b7ffe0;
      border-radius: 999px;
      padding: 2px 6px;
      border: 1px solid rgba(51, 255, 153, 0.5);
    }

    /* Â§çÈÄâÊ°ÜË°å */
    .checkbox-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .checkbox-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(10, 15, 40, 0.96);
      cursor: pointer;
    }

    .checkbox-chip input {
      margin: 0;
      width: 11px;
      height: 11px;
    }

    /* Âè≥‰æßÔºöÈ¢ÑËßà + Êä•‰ª∑ */
    .right-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .viewer-card {
      background: rgba(10, 15, 40, 0.96);
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 10px;
    }

    .viewer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 6px;
    }

    .viewer-badge {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-muted);
    }

    #viewerCanvas {
      width: 100%;
      height: 240px;
      border-radius: 14px;
      background: radial-gradient(circle at top, #1b2445 0, #020512 60%);
      border: 1px solid rgba(255, 255, 255, 0.08);
      overflow: hidden;
    }

    @media (max-width: 960px) {
      #viewerCanvas {
        height: 220px;
      }
    }

    .summary-card {
      background: radial-gradient(circle at top left, #23345c 0, #050816 55%);
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      padding: 12px 12px 10px;
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .summary-title {
      font-size: 14px;
      font-weight: 500;
    }

    .summary-chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(51, 255, 153, 0.15);
      color: #b7ffe0;
    }

    .price-main {
      font-size: 26px;
      font-weight: 650;
      letter-spacing: 0.03em;
      margin: 2px 0 0;
    }

    .price-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .price-sub span {
      color: #e2e3ff;
    }

    .breakdown {
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      margin-top: 6px;
      padding-top: 6px;
      font-size: 12px;
    }

    .breakdown-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
      color: var(--text-muted);
    }

    .breakdown-row span.value {
      color: #e7e7f9;
    }

    .note {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .note-strong {
      color: #ffeaa7;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent);
      color: #050816;
      font-weight: 500;
      box-shadow: 0 10px 30px rgba(79, 156, 255, 0.4);
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    button span.icon {
      font-size: 14px;
    }

    button.secondary {
      background: transparent;
      color: var(--text-muted);
      box-shadow: none;
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 36px rgba(79, 156, 255, 0.5);
      background: #6ba9ff;
    }

    button.secondary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
      background: rgba(255, 255, 255, 0.04);
    }

    .error {
      font-size: 11px;
      color: var(--danger);
      margin-top: 4px;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .summary-json {
      margin-top: 8px;
      font-size: 10px;
      color: var(--text-muted);
    }

    .summary-json textarea {
      font-family: monospace;
      font-size: 10px;
      background: rgba(5, 7, 20, 0.96);
      border-radius: 10px;
      padding: 6px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      color: #dfe3ff;
      height: 80px;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- È°∂ÈÉ®ÊèêÁ§∫Êù° -->
    <div class="top-bar">
      <div class="top-bar-left">
        <div class="status-dot"></div>
        <span>Upload your model to get an instant estimate ‚Äî no login required.</span>
      </div>
      <span class="tag">STL / 3MF / OBJ / STEP ¬∑ up to 500MB</span>
    </div>

    <header>
      <h1>Iceberg 3D ¬∑ Custom 3D Printing Quote</h1>
      <p>
        This tool gives you a live estimate based on your model, material and quality choices.
        Final quote will be confirmed by our team before payment.
      </p>
    </header>

    <div class="main-card">
      <div class="layout">
        <!-- Â∑¶‰æßÔºö‰∏ä‰º† + ËÆæÁΩÆ -->
        <div>
          <!-- ‚ë† Êñá‰ª∂‰∏ä‰º†Âå∫ -->
          <div class="section-label">
            <span class="icon">‚ë†</span> Upload model
          </div>
          <h2>Upload your 3D file</h2>
          <p class="sub-text">
            Drag & drop your STL / 3MF / OBJ / STEP files here. You can upload multiple parts in one go.
          </p>

          <div id="uploadCard" class="upload-card">
            <div id="uploadInner" class="upload-inner">
              <div class="upload-icon">‚§¥Ô∏è</div>
              <div>
                <div class="upload-text-main">Drop files here, or click to browse</div>
                <div class="upload-text-sub">
                  We‚Äôll try to preview the first STL file in 3D. Larger files may take a moment to load.
                </div>
                <div class="badge-filetypes">
                  <span>STL</span>¬∑<span>3MF</span>¬∑<span>OBJ</span>¬∑<span>STEP</span>
                </div>
              </div>
            </div>
            <input
              id="fileInput"
              type="file"
              multiple
              style="display:none"
              accept=".stl,.STL,.3mf,.3MF,.obj,.OBJ,.step,.stp,.STEP,.STP"
            />

            <div id="fileList" class="file-list"></div>
          </div>

          <!-- ‚ë£ ÊâìÂç∞ÂèÇÊï∞ÔºàÂÖ∂‰∏≠ÂåÖÂê´ÈáçÈáèËæìÂÖ•Ôºâ -->
          <div class="section-label" style="margin-top:12px;">
            <span class="icon">‚ë°</span> Print settings
          </div>
          <h2>Print quality & basic settings</h2>

          <div class="field-group field-row">
            <div>
              <label class="label-main" for="quality">Quality preset</label>
              <select id="quality">
                <option value="draft">Draft ‚Äì visual check / fit test</option>
                <option value="standard" selected>Standard ‚Äì balance of quality & time</option>
                <option value="high">High detail ‚Äì display / presentation</option>
                <option value="ultra">Ultra fine ‚Äì special cases only</option>
              </select>
              <div class="hint">
                We‚Äôll map this to layer height, wall thickness and speed automatically.
              </div>
            </div>
            <div>
              <label class="label-main" for="useCase">Primary use</label>
              <select id="useCase">
                <option value="visual">Visual / prototype</option>
                <option value="functional">Functional part</option>
                <option value="art">Art / display piece</option>
              </select>
              <div class="hint">
                Functional parts will get stronger shells & infill by default.
              </div>
            </div>
          </div>

          <div class="field-group field-row">
            <div>
              <label class="label-main" for="weightTotal">
                Estimated total weight (g)
              </label>
              <input
                type="number"
                id="weightTotal"
                min="1"
                step="1"
                placeholder="e.g. 70"
              />
              <div class="hint">
                Use the total from your slicer (all parts combined). We include the first 50g in
                the base price.
              </div>
            </div>
            <div>
              <label class="label-main" for="copies">
                Quantity (number of identical sets)
              </label>
              <input
                type="number"
                id="copies"
                min="1"
                step="1"
                value="1"
              />
              <div class="hint">
                We‚Äôll show both total and per-set pricing.
              </div>
            </div>
          </div>

          <!-- ‚ë¢ ÊùêÊñôÈÄâÊã© -->
          <div class="section-label" style="margin-top:10px;">
            <span class="icon">‚ë¢</span> Material selection
          </div>
          <div class="segmented-control">
            <div class="segmented-option active" data-material-mode="fdm">
              FDM (filament)
            </div>
            <div class="segmented-option" data-material-mode="sla">
              Resin (SLA)
            </div>
          </div>

          <!-- FDM ÊùêÊñô -->
          <div id="fdmMaterials" class="field-group">
            <label>FDM materials (for most orders)</label>
            <div class="material-grid">
              <div class="material-card active" data-material="pla">
                <div class="material-name">
                  <span>PLA ‚Äì standard</span>
                  <span class="material-pill">1.0√ó</span>
                </div>
                <div class="material-meta">
                  Most use cases ¬∑ good surface ¬∑ low warp
                </div>
              </div>

              <div class="material-card" data-material="petg">
                <div class="material-name">
                  <span>PETG</span>
                  <span class="material-pill">1.25√ó</span>
                </div>
                <div class="material-meta">
                  Tougher, more heat resistant than PLA
                </div>
              </div>

              <div class="material-card" data-material="tpu">
                <div class="material-name">
                  <span>TPU (flexible)</span>
                  <span class="material-pill">1.35√ó</span>
                </div>
                <div class="material-meta">
                  Flexible parts ¬∑ please contact us to confirm feasibility
                </div>
              </div>

              <div class="material-card" data-material="pla_cf">
                <div class="material-name">
                  <span>PLA-CF / PETG-CF</span>
                  <span class="material-pill">1.45√ó</span>
                </div>
                <div class="material-meta">
                  Carbon-fibre reinforced ¬∑ high stiffness, low warp
                </div>
              </div>

              <div class="material-card" data-material="asa_abs">
                <div class="material-name">
                  <span>ASA / ABS</span>
                  <span class="material-pill">1.40√ó</span>
                </div>
                <div class="material-meta">
                  Better outdoor performance, slightly higher warp risk
                </div>
              </div>

              <div class="material-card" data-material="pc">
                <div class="material-name">
                  <span>PC</span>
                  <span class="material-pill">1.60√ó</span>
                </div>
                <div class="material-meta">
                  High strength, heat resistant engineering plastic
                </div>
              </div>

              <div class="material-card" data-material="pa">
                <div class="material-name">
                  <span>PA (Nylon)</span>
                  <span class="material-pill">1.80√ó</span>
                </div>
                <div class="material-meta">
                  Impact resistant, good for functional parts
                </div>
              </div>

              <div class="material-card" data-material="pa_cf">
                <div class="material-name">
                  <span>PA-CF (Nylon CF)</span>
                  <span class="material-pill badge-strong">2.0√ó</span>
                </div>
                <div class="material-meta">
                  Very high stiffness & strength ¬∑ engineering applications
                </div>
              </div>
            </div>
          </div>

          <!-- SLA ÊùêÊñôÔºàËøôÈáåÂè™ÂΩ±ÂìçÊñáÊ°àÔºåËÆ°‰ª∑‰ªçËµ∞Âêå‰∏ÄÂÖ¨ÂºèÔºåÂèØÊåâÈúÄÊâ©Â±ïÔºâ -->
          <div id="slaMaterials" class="field-group" style="display:none;">
            <label>Resin materials (SLA)</label>
            <div class="material-grid">
              <div class="material-card" data-material="resin_standard">
                <div class="material-name">
                  <span>Standard resin</span>
                  <span class="material-pill">1.4√ó</span>
                </div>
                <div class="material-meta">
                  Smooth surface, high detail for displays & minis
                </div>
              </div>
              <div class="material-card" data-material="resin_tough">
                <div class="material-name">
                  <span>Tough / engineering resin</span>
                  <span class="material-pill">1.6√ó</span>
                </div>
                <div class="material-meta">
                  Stronger & less brittle than standard resin
                </div>
              </div>
              <div class="material-card" data-material="resin_clear">
                <div class="material-name">
                  <span>Clear resin</span>
                  <span class="material-pill">1.7√ó</span>
                </div>
                <div class="material-meta">
                  For transparent parts ¬∑ requires extra post-processing
                </div>
              </div>
              <div class="material-card" data-material="resin_flexible">
                <div class="material-name">
                  <span>Flexible resin</span>
                  <span class="material-pill">1.8√ó</span>
                </div>
                <div class="material-meta">
                  Flexible, rubber-like ¬∑ for special applications
                </div>
              </div>
            </div>
          </div>

          <!-- È¢úËâ≤ÈÄâÊã© -->
          <div class="field-group">
            <label class="label-main" for="colourCategory">
              Colour category
            </label>
            <select id="colourCategory">
              <option value="bw">Black / white (no surcharge)</option>
              <option value="standard">Standard colour (red / blue / grey etc.)</option>
              <option value="metallic">Metallic / silk / special texture</option>
              <option value="special">Special-order colour (to be confirmed)</option>
            </select>
            <div class="hint">
              Surcharge is applied per set. Special-order colours will be manually adjusted
              based on supplier cost.
            </div>
          </div>

          <!-- ‚ë§ ÂêéÂ§ÑÁêÜ -->
          <div class="section-label" style="margin-top:12px;">
            <span class="icon">‚ë£</span> Post-processing (optional)
          </div>
          <h2>Finishing & assembly</h2>
          <p class="sub-text">
            Choose any extra finishing you require. We‚Äôll include them in your estimate.
          </p>

          <div class="checkbox-row">
            <label class="checkbox-chip">
              <input type="checkbox" id="finishing_sanding" />
              <span>Sanding / support clean-up</span>
            </label>
            <label class="checkbox-chip">
              <input type="checkbox" id="finishing_paint_matte" />
              <span>Spray painting ‚Äì matte</span>
            </label>
            <label class="checkbox-chip">
              <input type="checkbox" id="finishing_paint_glossy" />
              <span>Spray painting ‚Äì glossy</span>
            </label>
            <label class="checkbox-chip">
              <input type="checkbox" id="finishing_gap" />
              <span>Gap filling / seam smoothing</span>
            </label>
            <label class="checkbox-chip">
              <input type="checkbox" id="finishing_assembly" />
              <span>Multi-part assembly</span>
            </label>
            <label class="checkbox-chip">
              <input type="checkbox" id="finishing_clear" />
              <span>Extra polish for clear parts</span>
            </label>
          </div>

          <!-- ‚ë• Â∞∫ÂØ∏ / Êï∞ÈáèÔºàÁº©ÊîæÔºâ -->
          <div class="section-label" style="margin-top:12px;">
            <span class="icon">‚ë§</span> Scaling & dimensions
          </div>

          <div class="field-group field-row">
            <div>
              <label class="label-main" for="scale">
                Scale factor
              </label>
              <input
                type="number"
                id="scale"
                min="0.1"
                step="0.05"
                value="1"
              />
              <div class="hint">
                1.0 = original size. Changing scale will update estimated weight suggestion.
              </div>
            </div>
            <div>
              <label for="dimensions">Approx. size (mm)</label>
              <input
                type="text"
                id="dimensions"
                placeholder="e.g. 120 √ó 60 √ó 40"
              />
              <div class="hint">
                Optional, but helps us sanity-check feasibility.
              </div>
            </div>
          </div>

          <!-- ‚ë¶ Âë®Êúü -->
          <div class="section-label" style="margin-top:12px;">
            <span class="icon">‚ë•</span> Lead time
          </div>

          <div class="field-group">
            <label class="label-main" for="deadline">When do you need it?</label>
            <select id="deadline">
              <option value="economy">Economy ¬∑ 3‚Äì7 working days</option>
              <option value="standard" selected>Standard ¬∑ 2‚Äì4 working days</option>
              <option value="urgent">Urgent ¬∑ same / next working day (subject to capacity)</option>
            </select>
            <div class="hint">
              Urgent jobs incur an express fee. For very large / complex prints we‚Äôll confirm
              what‚Äôs realistic.
            </div>
          </div>

          <!-- ‚ëß ÈÖçÈÄÅ -->
          <div class="section-label" style="margin-top:12px;">
            <span class="icon">‚ë¶</span> Delivery / collection
          </div>
          <div class="field-group field-row">
            <div>
              <label class="label-main" for="delivery">
                How would you like to receive your order?
              </label>
              <select id="delivery">
                <option value="pickup">
                  Collection ‚Äì Manchester M3 studio (free)
                </option>
                <option value="courier_local">
                  Local drop-off within ~5km of M3
                </option>
                <option value="rm24">Royal Mail 24 / Tracked 24</option>
                <option value="rm48">Royal Mail 48</option>
                <option value="evri">Evri / economy courier</option>
              </select>
              <div class="hint">
                Exact courier will be confirmed with your address. International shipping on request.
              </div>
            </div>
            <div>
              <label for="postcode">Postcode (for delivery estimate)</label>
              <input type="text" id="postcode" placeholder="e.g. M3 5GY" />
            </div>
          </div>

          <!-- ‚ë® ÂÆ¢Êà∑‰ø°ÊÅØ -->
          <div class="section-label" style="margin-top:12px;">
            <span class="icon">‚ëß</span> Contact details
          </div>
          <div class="field-group field-row">
            <div>
              <label class="label-main" for="customerName">Name</label>
              <input type="text" id="customerName" placeholder="Your name" />
            </div>
            <div>
              <label class="label-main" for="customerEmail">Email</label>
              <input
                type="email"
                id="customerEmail"
                placeholder="We‚Äôll send a copy of this quote here"
              />
            </div>
          </div>
          <div class="field-group field-row">
            <div>
              <label for="whatsapp">WhatsApp (optional)</label>
              <input
                type="text"
                id="whatsapp"
                placeholder="+44‚Ä¶"
              />
            </div>
            <div>
              <label for="company">Company / project name (optional)</label>
              <input
                type="text"
                id="company"
                placeholder="If this is for a company / event"
              />
            </div>
          </div>
          <div class="field-group">
            <label for="notes">
              Instructions / requirements
            </label>
            <textarea
              id="notes"
              placeholder="Anything else we should know? e.g. critical dimensions, surface expectations, assembly instructions‚Ä¶"
            ></textarea>
          </div>

          <!-- ‚ë´ Terms -->
          <div class="footer-note">
            <b>IP & file handling</b> ¬∑ By uploading files, you confirm you own the rights or
            have permission to produce the model. Files are kept only for production and basic
            backup, and can be deleted on request after completion.
          </div>
        </div>

        <!-- Âè≥‰æßÔºöÈ¢ÑËßà + Êä•‰ª∑ÁªìÊûú -->
        <div class="right-panel">
          <!-- 3D È¢ÑËßà -->
          <div class="viewer-card">
            <div class="viewer-header">
              <span>Model preview</span>
              <span class="viewer-badge">Experimental ¬∑ STL only</span>
            </div>
            <div id="viewerCanvas"></div>
          </div>

          <!-- Êä•‰ª∑ÁªìÊûú -->
          <div class="summary-card">
            <div class="summary-header">
              <div class="summary-title">Live estimate</div>
              <div class="summary-chip">Internal rules applied</div>
            </div>
            <div class="price-main" id="totalPrice">¬£0.00</div>
            <div class="price-sub">
              Approx. <span id="pricePerSet">¬£0.00</span> per set
            </div>

            <div class="breakdown">
              <div class="breakdown-row">
                <span>Base (incl. first 50g)</span>
                <span class="value" id="bd_base">¬£19.00</span>
              </div>
              <div class="breakdown-row">
                <span>Extra weight</span>
                <span class="value" id="bd_extraWeight">¬£0.00</span>
              </div>
              <div class="breakdown-row">
                <span>Material / quality adjustments</span>
                <span class="value" id="bd_materialLayer">¬£0.00</span>
              </div>
              <div class="breakdown-row">
                <span>Post-processing & finish</span>
                <span class="value" id="bd_finishing">¬£0.00</span>
              </div>
              <div class="breakdown-row">
                <span>Deadline & delivery adjustments</span>
                <span class="value" id="bd_deadlineDelivery">¬£0.00</span>
              </div>
              <div class="breakdown-row">
                <span>Colour surcharge</span>
                <span class="value" id="bd_colour">¬£0.00</span>
              </div>
              <div class="breakdown-row">
                <span><b>Total (all sets)</b></span>
                <span class="value" id="bd_total"><b>¬£0.00</b></span>
              </div>
            </div>

            <div class="note">
              This estimate is based on our internal pricing rules for custom FDM / SLA printing.
              Very complex jobs, multi-material prints or special requests may require manual review.
            </div>
            <div id="errorMsg" class="error" style="display:none;"></div>

            <div class="btn-row">
              <button id="btnRequest">
                <span class="icon">üì©</span>
                Confirm & request final quote
              </button>
              <button id="btnCopy" class="secondary">
                <span class="icon">üìã</span>
                Copy summary
              </button>
            </div>

            <!-- ËÆ¢ÂçïÈ¢ÑËßà / ‰øùÂ≠òÔºöÁîüÊàê JSON Êñπ‰æø‰Ω†Âú® Wix / ÈÇÆ‰ª∂ÈáåÁî® -->
            <div class="summary-json">
              <div style="margin-bottom:4px;">Quote summary (you can copy & paste into email / CRM):</div>
              <textarea id="summaryOutput" readonly></textarea>
            </div>
          </div>

          <div class="footer-note">
            <b>Next steps</b> ¬∑ Click ‚ÄúConfirm & request final quote‚Äù to send us these details.
            On Wix, you can either embed this page in an iFrame and hook the button into your
            existing form, or forward the summary via email / CRM manually.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== ÂÜÖÈÉ®ËÆ°‰ª∑ËßÑÂàô ==========
    // ‰Ω†ÁªôÁöÑËßÑÂàôÔºöËµ∑Ê≠• ¬£19 Âê´ 50gÔºåË∂ÖÂá∫ÈÉ®ÂàÜ ¬£0.20/g
    const BASE_PRICE = 19;
    const INCLUDED_WEIGHT = 50;
    const EXTRA_RATE_PER_G = 0.2;

    const MATERIAL_FACTORS = {
      pla: 1.0,
      petg: 1.25,
      tpu: 1.35,
      pla_cf: 1.45,
      asa_abs: 1.4,
      pc: 1.6,
      pa: 1.8,
      pa_cf: 2.0,
      // Resin ËøôËæπÁî®Áï•È´òÁ≥ªÊï∞ÔºåÂèØ‰ª•ÊåâÈúÄÊîπ
      resin_standard: 1.4,
      resin_tough: 1.6,
      resin_clear: 1.7,
      resin_flexible: 1.8,
    };

    const QUALITY_LAYER_FACTORS = {
      draft: 0.85,    // ÂØπÂ∫î 0.28
      standard: 1.0,  // ÂØπÂ∫î 0.20
      high: 1.4,      // ÂØπÂ∫î 0.12
      ultra: 1.8,     // ÂØπÂ∫î 0.08
    };

    const COLOUR_SURCHARGE_PER_SET = {
      bw: 0,
      standard: 2,
      metallic: 3,
      special: 0, // ÁâπÊÆäËâ≤Âú®Â§áÊ≥®ÊèêÁ§∫Ôºå‰∏çÁõ¥Êé•Âä†‰ª∑
    };

    const DEADLINE_FACTORS = {
      economy: 1.0,
      standard: 1.15,
      urgent: 1.5,
    };

    const DELIVERY_FEES = {
      pickup: 0,
      courier_local: 6,
      rm24: 8,
      rm48: 6,
      evri: 5,
    };

    // ÁÆÄÂçïÂêéÂ§ÑÁêÜÂä†‰ª∑ÔºàÊØè‰∏™ setÔºâ
    const FINISHING_FEES_PER_SET = {
      sanding: 5,
      paint_matte: 10,
      paint_glossy: 12,
      gap: 6,
      assembly: 8,
      clear: 10,
    };

    function toMoney(v) {
      return v.toFixed(2);
    }

    // ========== Êä•‰ª∑ËÆ°ÁÆó ==========
    function calculateQuote() {
      const weightTotal = parseFloat(
        document.getElementById("weightTotal").value || "0"
      );
      let copies = parseInt(
        document.getElementById("copies").value || "1",
        10
      );
      if (isNaN(copies) || copies <= 0) copies = 1;

      const qualityKey = document.getElementById("quality").value;
      const deadlineKey = document.getElementById("deadline").value;
      const deliveryKey = document.getElementById("delivery").value;
      const colourKey = document.getElementById("colourCategory").value;

      const materialEl = document.querySelector(".material-card.active");
      const materialKey = materialEl ? materialEl.getAttribute("data-material") : "pla";

      const errorEl = document.getElementById("errorMsg");

      if (!weightTotal || weightTotal <= 0) {
        errorEl.style.display = "block";
        errorEl.textContent = "Please enter an estimated total weight from your slicer (greater than 0g).";
      } else {
        errorEl.style.display = "none";
        errorEl.textContent = "";
      }

      const materialFactor = MATERIAL_FACTORS[materialKey] || 1.0;
      const layerFactor = QUALITY_LAYER_FACTORS[qualityKey] || 1.0;
      const deadlineFactor = DEADLINE_FACTORS[deadlineKey] || 1.0;
      const deliveryFee = DELIVERY_FEES[deliveryKey] || 0;
      const colourPerSet = COLOUR_SURCHARGE_PER_SET[colourKey] || 0;

      const extraWeight = Math.max(0, weightTotal - INCLUDED_WEIGHT);
      const extraFee = extraWeight * EXTRA_RATE_PER_G;
      const basePlusExtra = BASE_PRICE + extraFee;

      // Ê†∏ÂøÉÔºöÊùêÊñô + Â±ÇÈ´ò
      const materialLayerAdjusted = basePlusExtra * materialFactor * layerFactor;

      // ÂêéÂ§ÑÁêÜ
      let finishingPerSet = 0;
      if (document.getElementById("finishing_sanding").checked)
        finishingPerSet += FINISHING_FEES_PER_SET.sanding;
      if (document.getElementById("finishing_paint_matte").checked)
        finishingPerSet += FINISHING_FEES_PER_SET.paint_matte;
      if (document.getElementById("finishing_paint_glossy").checked)
        finishingPerSet += FINISHING_FEES_PER_SET.paint_glossy;
      if (document.getElementById("finishing_gap").checked)
        finishingPerSet += FINISHING_FEES_PER_SET.gap;
      if (document.getElementById("finishing_assembly").checked)
        finishingPerSet += FINISHING_FEES_PER_SET.assembly;
      if (document.getElementById("finishing_clear").checked)
        finishingPerSet += FINISHING_FEES_PER_SET.clear;

      // È¢úËâ≤ + ÂêéÂ§ÑÁêÜÈÉΩÊòØÊåâ set ËÆ°ÁÆó
      const colourTotal = colourPerSet * copies;
      const finishingTotal = finishingPerSet * copies;

      // ‰∫§ÊúüÁ≥ªÊï∞‰ΩúÁî®Âú®Ê†∏ÂøÉÊâìÂç∞Ë¥πÁî®‰∏ä
      const coreWithDeadline = materialLayerAdjusted * deadlineFactor;

      // ÊÄª‰ª∑ÔºàÊâÄÊúâ setÔºâ
      const subtotalPerSet = coreWithDeadline + finishingPerSet + colourPerSet;
      const totalAllSets = subtotalPerSet * copies + deliveryFee;

      const pricePerSet = subtotalPerSet;

      // Êõ¥Êñ∞Âè≥‰æßÂ±ïÁ§∫
      document.getElementById("bd_base").textContent = "¬£" + toMoney(BASE_PRICE);
      document.getElementById("bd_extraWeight").textContent = "¬£" + toMoney(extraFee);
      document.getElementById("bd_materialLayer").textContent = "¬£" + toMoney(materialLayerAdjusted - BASE_PRICE - extraFee);
      document.getElementById("bd_finishing").textContent = "¬£" + toMoney(finishingTotal);
      document.getElementById("bd_deadlineDelivery").textContent =
        "¬£" + toMoney(coreWithDeadline - materialLayerAdjusted + deliveryFee);
      document.getElementById("bd_colour").textContent = "¬£" + toMoney(colourTotal);

      document.getElementById("bd_total").textContent = "¬£" + toMoney(totalAllSets);
      document.getElementById("totalPrice").textContent = "¬£" + toMoney(totalAllSets);
      document.getElementById("pricePerSet").textContent = "¬£" + toMoney(pricePerSet);

      // ÁîüÊàê summary JSON Êñπ‰æø‰Ω†Â§çÂà∂
      const summary = buildSummaryObject(totalAllSets, pricePerSet);
      document.getElementById("summaryOutput").value = JSON.stringify(
        summary,
        null,
        2
      );
    }

    function buildSummaryObject(totalAllSets, pricePerSet) {
      const materialEl = document.querySelector(".material-card.active");
      const materialKey = materialEl ? materialEl.getAttribute("data-material") : "pla";
      const materialLabel = materialEl
        ? materialEl.querySelector(".material-name span").textContent
        : "PLA";

      const files = uploadedFiles.map((f) => ({
        name: f.name,
        sizeBytes: f.size,
        type: f.type,
      }));

      return {
        files,
        print: {
          quality: document.getElementById("quality").value,
          useCase: document.getElementById("useCase").value,
          estimatedWeightTotal_g: Number(
            document.getElementById("weightTotal").value || 0
          ),
          copies: Number(document.getElementById("copies").value || 1),
          materialKey,
          materialLabel,
          colourCategory: document.getElementById("colourCategory").value,
          scaleFactor: Number(document.getElementById("scale").value || 1),
          approxDimensions: document.getElementById("dimensions").value,
          deadline: document.getElementById("deadline").value,
          delivery: document.getElementById("delivery").value,
          postcode: document.getElementById("postcode").value,
          finishing: {
            sanding: document.getElementById("finishing_sanding").checked,
            paint_matte: document.getElementById("finishing_paint_matte").checked,
            paint_glossy: document.getElementById("finishing_paint_glossy").checked,
            gap_filling: document.getElementById("finishing_gap").checked,
            assembly: document.getElementById("finishing_assembly").checked,
            clear_polish: document.getElementById("finishing_clear").checked,
          },
        },
        customer: {
          name: document.getElementById("customerName").value,
          email: document.getElementById("customerEmail").value,
          whatsapp: document.getElementById("whatsapp").value,
          company: document.getElementById("company").value,
          notes: document.getElementById("notes").value,
        },
        pricing: {
          currency: "GBP",
          totalAllSets: totalAllSets,
          pricePerSet: pricePerSet,
        },
        meta: {
          generatedAt: new Date().toISOString(),
          source: "Iceberg 3D quote v2",
        },
      };
    }

    // ========== ‰∏ä‰º† & 3D È¢ÑËßà ==========
    const uploadCard = document.getElementById("uploadCard");
    const uploadInner = document.getElementById("uploadInner");
    const fileInput = document.getElementById("fileInput");
    const fileListEl = document.getElementById("fileList");
    let uploadedFiles = [];

    uploadInner.addEventListener("click", () => fileInput.click());

    uploadCard.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadCard.classList.add("dragover");
    });
    uploadCard.addEventListener("dragleave", (e) => {
      e.preventDefault();
      uploadCard.classList.remove("dragover");
    });
    uploadCard.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadCard.classList.remove("dragover");
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener("change", (e) => {
      handleFiles(e.target.files);
      fileInput.value = "";
    });

    function handleFiles(fileList) {
      const arr = Array.from(fileList);
      arr.forEach((file) => {
        uploadedFiles.push(file);
      });
      renderFileList();
      // Â∞ùËØïÂä†ËΩΩÁ¨¨‰∏Ä‰∏™ STL ‰Ωú‰∏∫ 3D È¢ÑËßà
      const stlFile = uploadedFiles.find((f) =>
        f.name.toLowerCase().endsWith(".stl")
      );
      if (stlFile) {
        loadStlPreview(stlFile);
      }
    }

    function renderFileList() {
      if (!uploadedFiles.length) {
        fileListEl.innerHTML = "";
        return;
      }
      fileListEl.innerHTML = uploadedFiles
        .map((file, idx) => {
          const sizeKB = file.size / 1024;
          const sizeLabel =
            sizeKB > 1024
              ? (sizeKB / 1024).toFixed(2) + " MB"
              : sizeKB.toFixed(1) + " KB";
          const ext = (file.name.split(".").pop() || "").toUpperCase();
          return `
          <div class="file-item">
            <div class="file-main">
              <div class="file-badge">${ext || "3D"}</div>
              <div>
                <div>${file.name}</div>
                <div class="file-meta">${sizeLabel}</div>
              </div>
            </div>
            <button class="file-remove" data-index="${idx}">‚úï</button>
          </div>
        `;
        })
        .join("");

      fileListEl.querySelectorAll(".file-remove").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const idx = parseInt(e.target.getAttribute("data-index"), 10);
          uploadedFiles.splice(idx, 1);
          renderFileList();
        });
      });
    }

    // Three.js È¢ÑËßà
    let scene, camera, renderer, controls;
    let currentMesh;
    const viewerEl = document.getElementById("viewerCanvas");

    function initViewer() {
      const width = viewerEl.clientWidth || 300;
      const height = viewerEl.clientHeight || 240;

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x050816);

      camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
      camera.position.set(0, 40, 80);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(width, height);
      viewerEl.appendChild(renderer.domElement);

      const ambient = new THREE.AmbientLight(0xffffff, 0.7);
      scene.add(ambient);
      const dir = new THREE.DirectionalLight(0xffffff, 0.8);
      dir.position.set(40, 60, 40);
      scene.add(dir);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      animate();
    }

    function animate() {
      requestAnimationFrame(animate);
      if (controls) controls.update();
      if (renderer && scene && camera) renderer.render(scene, camera);
    }

    function loadStlPreview(file) {
      if (!scene) initViewer();
      const reader = new FileReader();
      reader.onload = function (e) {
        const contents = e.target.result;
        const loader = new THREE.STLLoader();
        const geometry = loader.parse(contents);
        geometry.center();

        if (currentMesh) {
          scene.remove(currentMesh);
        }

        const material = new THREE.MeshStandardMaterial({
          color: 0x4f9cff,
          metalness: 0.2,
          roughness: 0.3,
        });
        const mesh = new THREE.Mesh(geometry, material);
        mesh.castShadow = true;
        mesh.receiveShadow = true;
        scene.add(mesh);
        currentMesh = mesh;

        geometry.computeBoundingBox();
        const bbox = geometry.boundingBox;
        const size = new THREE.Vector3();
        bbox.getSize(size);
        const maxDim = Math.max(size.x, size.y, size.z);

        const fitDistance =
          maxDim / (2 * Math.tan((Math.PI * camera.fov) / 360));
        camera.position.set(fitDistance, fitDistance, fitDistance);
        camera.lookAt(0, 0, 0);
        controls.target.set(0, 0, 0);
        controls.update();
      };
      reader.readAsArrayBuffer(file);
    }

    // ========== UI ‰∫ã‰ª∂ÁªëÂÆö ==========
    function bindMaterialSwitching() {
      const fdmBtn = document.querySelector(
        '.segmented-option[data-material-mode="fdm"]'
      );
      const slaBtn = document.querySelector(
        '.segmented-option[data-material-mode="sla"]'
      );
      const fdmBox = document.getElementById("fdmMaterials");
      const slaBox = document.getElementById("slaMaterials");

      fdmBtn.addEventListener("click", () => {
        fdmBtn.classList.add("active");
        slaBtn.classList.remove("active");
        fdmBox.style.display = "block";
        slaBox.style.display = "none";
        // ÈªòËÆ§ÈÄâ PLA
        document
          .querySelectorAll("#fdmMaterials .material-card")
          .forEach((card, idx) => {
            card.classList.toggle("active", idx === 0);
          });
        calculateQuote();
      });

      slaBtn.addEventListener("click", () => {
        slaBtn.classList.add("active");
        fdmBtn.classList.remove("active");
        fdmBox.style.display = "none";
        slaBox.style.display = "block";
        // ÈªòËÆ§ÈÄâÁ¨¨‰∏Ä‰∏™ resin
        const cards = document.querySelectorAll("#slaMaterials .material-card");
        cards.forEach((card, idx) => {
          card.classList.toggle("active", idx === 0);
        });
        calculateQuote();
      });

      document
        .querySelectorAll("#fdmMaterials .material-card, #slaMaterials .material-card")
        .forEach((card) => {
          card.addEventListener("click", () => {
            const parent = card.parentElement;
            parent
              .querySelectorAll(".material-card")
              .forEach((c) => c.classList.remove("active"));
            card.classList.add("active");
            calculateQuote();
          });
        });
    }

    function bindInputs() {
      const ids = [
        "quality",
        "useCase",
        "weightTotal",
        "copies",
        "colourCategory",
        "scale",
        "dimensions",
        "deadline",
        "delivery",
        "postcode",
        "finishing_sanding",
        "finishing_paint_matte",
        "finishing_paint_glossy",
        "finishing_gap",
        "finishing_assembly",
        "finishing_clear",
      ];
      ids.forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("input", calculateQuote);
        el.addEventListener("change", calculateQuote);
      });

      document.getElementById("btnCopy").addEventListener("click", () => {
        const ta = document.getElementById("summaryOutput");
        ta.select();
        ta.setSelectionRange(0, 99999);
        document.execCommand("copy");
        alert("Quote summary copied. You can paste it into your email or CRM.");
      });

      document.getElementById("btnRequest").addEventListener("click", () => {
        // ËøôÈáåÂè™ÊòØÂâçÁ´Ø demoÔºöÂÆûÈôÖÂú® Wix ‰∏≠‰Ω†ÂèØ‰ª•Áî® onClick ÂéªËß¶ÂèëË°®ÂçïÊèê‰∫§ / ÈÇÆ‰ª∂
        alert(
          "Thank you! Please copy the summary below and send it to us, or integrate this button with your Wix form/email workflow."
        );
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      initViewer();
      bindMaterialSwitching();
      bindInputs();
      calculateQuote();
    });
  </script>
</body>
</html>
