<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iceberg 3D</title>
  <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }</script>
  <style>
    :root { --bg: #f4f7fb; --accent: #1f6b63; --text: #1f2933; }
    body { margin: 0; padding: 15px; background: var(--bg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; color: var(--text); }
    
    /* Â∏ÉÂ±ÄÊ†∑Âºè */
    .steps { display: grid; grid-template-columns: 1fr 1fr 0.8fr; gap: 15px; }
    @media (max-width: 800px) { .steps { grid-template-columns: 1fr; } }
    
    .card { background: #fff; border: 1px solid #dde3ee; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
    h3 { margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #666; display: flex; align-items: center; gap: 8px; }
    .badge { background: var(--accent); color: #fff; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }

    /* Êñá‰ª∂‰∏ä‰º†ÊåâÈíÆÁæéÂåñ */
    .file-upload-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
    .btn-file { border: 2px dashed #ccc; color: #555; background-color: #fafafa; padding: 20px; border-radius: 8px; font-size: 14px; font-weight: bold; width: 100%; cursor: pointer; text-align: center; transition: all 0.2s; }
    .btn-file:hover { border-color: var(--accent); color: var(--accent); background: #e0f2f0; }
    .btn-file input[type=file] { position: absolute; top: 0; right: 0; min-width: 100%; min-height: 100%; font-size: 100px; text-align: right; filter: alpha(opacity=0); opacity: 0; outline: none; background: white; cursor: inherit; display: block; }
    
    /* 3D È¢ÑËßà */
    #viewer { width: 100%; height: 200px; background: #f0f3f8; border-radius: 8px; margin-bottom: 10px; overflow: hidden; position: relative; }
    #placeholder { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#999; font-size:12px; }

    /* Ë°®ÂçïÊéß‰ª∂ */
    label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 4px; color: #555; }
    select, input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 14px; }
    
    /* ‰ª∑Ê†ºÂíåÊåâÈíÆ */
    .summary-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 5px; }
    .total { font-size: 18px; font-weight: bold; border-top: 1px solid #eee; padding-top: 10px; margin-top: 5px; }
    
    #payBtn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 99px; font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 10px; opacity: 0.5; pointer-events: none; transition: 0.2s; }
    #payBtn.active { opacity: 1; pointer-events: auto; }
    #payBtn:hover { background: #16524b; }

    /* Loading ÈÅÆÁΩ© */
    #overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 999; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div id="overlay">
  <div class="spinner"></div>
  <div id="statusText" style="color:#1f6b63; font-weight:600;">Processing Order...</div>
</div>

<div class="steps">
  <!-- 1. ‰∏ä‰º† -->
  <div class="card">
    <h3><span class="badge">1</span> Upload File</h3>
    <div class="file-upload-wrapper">
      <button class="btn-file">
        <span id="fileName">üìÇ Click to Select STL</span>
        <input type="file" id="fileInput" accept=".stl">
      </button>
    </div>
    <div style="margin-top:10px; font-size:12px; color:#666;">
      Est. Weight: <strong id="weightVal" style="color:var(--accent)">--</strong>
    </div>
    <div id="fileWarning" style="font-size:11px; color:#d9534f; margin-top:5px; display:none;">File too large (>4.5MB). Please email us directly.</div>
  </div>

  <!-- 2. ÊùêË¥® -->
  <div class="card">
    <h3><span class="badge">2</span> Configuration</h3>
    <div id="viewer"><div id="placeholder">Preview Area</div></div>
    
    <label>Material</label>
    <select id="matSelect"></select>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
      <div><label>Quality</label><select id="qualSelect"><option value="0.2">Standard</option><option value="0.12">Fine</option></select></div>
      <div><label>Qty</label><input type="number" id="qtyInput" value="1" min="1"></div>
    </div>
  </div>

  <!-- 3. ‰ª∑Ê†º -->
  <div class="card">
    <h3><span class="badge">3</span> Summary</h3>
    <div class="summary-row"><span>Base</span><span id="basePrice">¬£0.00</span></div>
    <div class="summary-row"><span>Weight Cost</span><span id="weightPrice">¬£0.00</span></div>
    <div class="summary-row total"><span>Total</span><span id="totalPrice">¬£0.00</span></div>
    
    <button id="payBtn">Pay Now</button>
    <div style="font-size:11px; color:#888; margin-top:8px;">Secure checkout via Wix</div>
  </div>
</div>

<script type="module">
  import * as THREE from 'three';
  import { STLLoader } from 'three/addons/loaders/STLLoader.js';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

  // ÈÖçÁΩÆ
  const PRICING = { start: 15.00, included: 40, perGram: 0.15, volFactor: 0.45 };
  const MATERIALS = { "PLA Basic": 1.0, "PLA Matte": 1.1, "PETG": 1.25, "TPU Flexible": 1.5 };
  
  let rawFile = null;
  let currentWeight = 0;
  
  const els = {
    file: document.getElementById('fileInput'),
    name: document.getElementById('fileName'),
    warn: document.getElementById('fileWarning'),
    weight: document.getElementById('weightVal'),
    mat: document.getElementById('matSelect'),
    qty: document.getElementById('qtyInput'),
    base: document.getElementById('basePrice'),
    wPrice: document.getElementById('weightPrice'),
    total: document.getElementById('totalPrice'),
    btn: document.getElementById('payBtn'),
    overlay: document.getElementById('overlay'),
    status: document.getElementById('statusText')
  };

  // ÂàùÂßãÂåñÊùêË¥®
  Object.keys(MATERIALS).forEach(k => els.mat.add(new Option(k,k)));

  // 3D Âú∫ÊôØ
  const scene = new THREE.Scene(); scene.background = new THREE.Color(0xf0f3f8);
  const cam = new THREE.PerspectiveCamera(45, 1, 0.1, 1000); cam.position.set(50,50,50);
  const renderer = new THREE.WebGLRenderer({antialias:true});
  document.getElementById('viewer').appendChild(renderer.domElement);
  const controls = new OrbitControls(cam, renderer.domElement); controls.autoRotate = true;
  scene.add(new THREE.AmbientLight(0xffffff, 0.6)); scene.add(new THREE.DirectionalLight(0xffffff, 0.8));

  function resize(){ const c=document.getElementById('viewer'); renderer.setSize(c.clientWidth, c.clientHeight); cam.aspect=c.clientWidth/c.clientHeight; cam.updateProjectionMatrix(); }
  window.addEventListener('resize', resize);
  function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,cam); }
  resize(); animate();

  // 1. Êñá‰ª∂Â§ÑÁêÜ
  els.file.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if(!file) return;

    // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è (ÈôêÂà∂ 4.5MB)
    if(file.size > 4.5 * 1024 * 1024) {
      els.warn.style.display = 'block';
      els.name.textContent = "‚ùå File too large";
      els.btn.classList.remove('active');
      rawFile = null;
      return;
    }

    els.warn.style.display = 'none';
    els.name.textContent = file.name;
    rawFile = file;

    const r = new FileReader();
    r.onload = (ev) => {
      try {
        const buffer = ev.target.result;
        const vol = computeVolume(buffer);
        currentWeight = (vol/1000.0) * PRICING.volFactor;
        
        // Ê∏≤Êüì
        const loader = new STLLoader(); const geom = loader.parse(buffer);
        geom.center(); geom.computeVertexNormals();
        scene.clear();
        scene.add(new THREE.AmbientLight(0xffffff, 0.6)); scene.add(new THREE.DirectionalLight(0xffffff, 0.8));
        const mesh = new THREE.Mesh(geom, new THREE.MeshStandardMaterial({color:0x1f6b63}));
        mesh.rotation.x = -Math.PI/2; scene.add(mesh);
        
        // Áõ∏Êú∫
        const box = new THREE.Box3().setFromObject(mesh);
        const size = box.getSize(new THREE.Vector3()).length();
        controls.maxDistance = size*5; cam.position.set(size, size, size);
        document.getElementById('placeholder').style.display = 'none';
        
        calcPrice();
      } catch(err) { alert("Invalid STL"); }
    };
    r.readAsArrayBuffer(file);
  });

  // 2. ÁÆó‰ª∑
  function calcPrice() {
    if(!rawFile || currentWeight<=0) return;
    const qty = parseInt(els.qty.value) || 1;
    const matMult = MATERIALS[els.mat.value];
    
    els.weight.textContent = Math.ceil(currentWeight) + ' g';
    
    let extra = Math.max(0, (currentWeight - PRICING.included) * PRICING.perGram);
    const total = (PRICING.start + extra) * matMult * qty;
    
    els.base.textContent = '¬£'+PRICING.start.toFixed(2);
    els.wPrice.textContent = '¬£'+(extra * matMult).toFixed(2);
    els.total.textContent = '¬£'+total.toFixed(2);
    
    els.btn.classList.add('active');
  }

  els.mat.addEventListener('change', calcPrice);
  els.qty.addEventListener('input', calcPrice);

  // 3. ÊîØ‰ªòÊµÅÁ®ã (Base64 ÊâìÂåÖ)
  els.btn.addEventListener('click', () => {
    if(!rawFile) return;
    
    els.overlay.style.display = 'flex';
    els.status.textContent = "Uploading & Creating Order...";

    // ËΩ¨Êç¢Êñá‰ª∂
    const reader = new FileReader();
    reader.onload = function(e) {
      const base64 = e.target.result;
      
      const details = {
        total: parseFloat(els.total.textContent.replace('¬£','')),
        material: els.mat.value,
        qty: els.qty.value
      };

      // ÂèëÈÄÅÁªô Wix
      window.parent.postMessage({
        type: 'START_CHECKOUT',
        payload: {
          fileData: base64,
          fileName: rawFile.name,
          details: details
        }
      }, '*');
    };
    reader.readAsDataURL(rawFile);
  });
  
  // 4. ÁõëÂê¨ Wix ‰º†ÂõûÁöÑÈîôËØØ
  window.addEventListener('message', (e) => {
    if(e.data && e.data.type === 'ERROR') {
      els.overlay.style.display = 'none';
      alert(e.data.message);
    }
  });
  
  // ‰ΩìÁßØÁÆóÊ≥ï
  function computeVolume(ab){
    const dv=new DataView(ab); const n=dv.getUint32(80,true); let v=0,off=84;
    for(let i=0;i<n;i++){
      const p1={x:dv.getFloat32(off+12,true),y:dv.getFloat32(off+16,true),z:dv.getFloat32(off+20,true)};
      const p2={x:dv.getFloat32(off+24,true),y:dv.getFloat32(off+28,true),z:dv.getFloat32(off+32,true)};
      const p3={x:dv.getFloat32(off+36,true),y:dv.getFloat32(off+40,true),z:dv.getFloat32(off+44,true)};
      v+=(p1.x*(p2.y*p3.z-p2.z*p3.y)-p1.y*(p2.x*p3.z-p2.z*p3.x)+p1.z*(p2.x*p3.y-p2.y*p3.x))/6.0; off+=50;
    } return Math.abs(v);
  }
</script>
</body>
</html>
