<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Iceberg 3D – Custom Printing Quote</title>
  <style>
    :root {
      /* 近似你的站点配色：深绿 + 浅蓝 */
      --iceberg-bg: #f4f7fb;
      --iceberg-card-bg: #ffffff;
      --iceberg-accent: #1f6b63;   /* 主绿色按钮 */
      --iceberg-accent-soft: #e0f2f0;
      --iceberg-border: #dde3ee;
      --iceberg-text-main: #1f2933;
      --iceberg-text-muted: #6b7280;
    }

    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    body {
      margin: 0;
      padding: 24px 16px 32px;
      background: var(--iceberg-bg);
      color: var(--iceberg-text-main);
    }

    .iceberg-quote-page {
      max-width: 1120px;
      margin: 0 auto;
    }

    .iqp-header-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      background: var(--iceberg-accent-soft);
      color: var(--iceberg-accent);
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .iqp-header-tag-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--iceberg-accent);
    }

    h1 {
      margin: 0 0 4px;
      font-size: 26px;
      letter-spacing: 0.02em;
    }

    .subtitle {
      font-size: 14px;
      color: var(--iceberg-text-muted);
      margin-bottom: 22px;
      max-width: 620px;
    }

    .steps {
      display: grid;
      grid-template-columns: 2.1fr 2.1fr 1.5fr;
      gap: 20px;
      align-items: flex-start;
    }

    .step-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .step-badge {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: var(--iceberg-accent);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }

    .card {
      background: var(--iceberg-card-bg);
      border: 1px solid var(--iceberg-border);
      border-radius: 14px;
      padding: 16px 16px 18px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.04);
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #4b5563;
    }

    .field-group {
      margin-bottom: 14px;
    }

    input[type="file"] {
      display: block;
      width: 100%;
      padding: 8px 0;
      font-size: 13px;
    }

    input[type="number"],
    select {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 10px;
      border: 1px solid #cfd4dd;
      outline: none;
      background: #fff;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    input[type="number"]:focus,
    select:focus {
      border-color: var(--iceberg-accent);
      box-shadow: 0 0 0 1px rgba(31, 107, 99, 0.12);
      background: #f9fbff;
    }

    .inline-fields {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .small-text {
      font-size: 11px;
      color: var(--iceberg-text-muted);
      margin-top: 2px;
      line-height: 1.4;
    }

    .weight-display-box {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px dashed #cfd4dd;
      background: #f9fafb;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .weight-display-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--iceberg-text-muted);
    }

    .weight-display-value {
      font-weight: 600;
    }

    .warning {
      font-size: 11px;
      color: #b45309;
      margin-top: 4px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 13px;
      color: #4b5563;
    }

    .summary-row strong {
      font-weight: 600;
      color: #111827;
    }

    .total-row {
      border-top: 1px solid var(--iceberg-border);
      margin-top: 10px;
      padding-top: 10px;
      font-size: 17px;
      font-weight: 700;
      color: #111827;
    }

    .btn-primary {
      width: 100%;
      margin-top: 12px;
      padding: 10px 0;
      border-radius: 999px;
      border: none;
      background: var(--iceberg-accent);
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.08s ease, box-shadow 0.12s ease;
      box-shadow: 0 8px 18px rgba(31, 107, 99, 0.28);
    }

    .btn-primary:disabled {
      background: #c1ccd4;
      box-shadow: none;
      cursor: not-allowed;
    }

    .btn-primary:not(:disabled):hover {
      background: #185249;
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(24, 82, 73, 0.35);
    }

    .quote-note {
      font-size: 11px;
      color: var(--iceberg-text-muted);
      margin-top: 6px;
      text-align: left;
      line-height: 1.4;
    }

    @media (max-width: 960px) {
      body {
        padding: 16px 10px 24px;
      }

      .steps {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="iceberg-quote-page">
  <div class="iqp-header-tag">
    <span class="iqp-header-tag-dot"></span>
    CUSTOM 3D PRINTING – INSTANT QUOTE
  </div>
  <h1>Get an instant estimate for your custom 3D print</h1>
  <p class="subtitle">
    Upload your STL, choose material, colour and layer height. We’ll estimate the weight from the file and give you a clear, upfront price before you place your order.
  </p>

  <div class="steps">
    <!-- STEP 1: FILE & AUTO WEIGHT -->
    <div>
      <div class="step-title">
        <span class="step-badge">1</span>
        <span>Upload your model</span>
      </div>
      <div class="card">
        <div class="field-group">
          <label for="fileInput">STL file</label>
          <input id="fileInput" type="file" accept=".stl" />
          <div class="small-text">
            Automatic quoting currently supports STL files. For other formats, you can still contact us for a manual quote.
          </div>
        </div>

        <div class="field-group">
          <label>Estimated weight</label>
          <div class="weight-display-box">
            <div>
              <div class="weight-display-label">per part</div>
              <div id="weightDisplay" class="weight-display-value">--</div>
            </div>
          </div>
          <div class="small-text">
            Calculated from the model volume, assuming typical 0.2&nbsp;mm FDM printing with standard infill. Final slicer weight may vary slightly.
          </div>
          <div id="weightWarning" class="warning" style="display:none;">
            Please upload a valid STL file so we can calculate the weight.
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 2: CONFIGURATION -->
    <div>
      <div class="step-title">
        <span class="step-badge">2</span>
        <span>Choose specs</span>
      </div>
      <div class="card">
        <div class="field-group">
          <label for="technologySelect">Technology</label>
          <select id="technologySelect" disabled>
            <option>FDM / FFF 3D Printing</option>
          </select>
          <div class="small-text">Quotes are for FDM printing. SLA / resin available on request.</div>
        </div>

        <div class="field-group">
          <label for="materialSelect">Material</label>
          <select id="materialSelect">
            <option value="PLA">PLA (standard)</option>
            <option value="PETG">PETG</option>
            <option value="TPU">TPU (flexible – please confirm)</option>
            <option value="PLA_CF">PLA-CF / PETG-CF</option>
            <option value="ASA_ABS">ASA / ABS</option>
            <option value="PC">PC</option>
            <option value="PA">PA / Nylon</option>
            <option value="PA_CF">PA-CF</option>
          </select>
        </div>

        <div class="field-group">
          <label for="colourSelect">Colour</label>
          <select id="colourSelect">
            <option value="basic">Black / White (no extra)</option>
            <option value="standard">Standard colour (red / blue / grey / green)</option>
            <option value="special">Metallic / silk / special texture</option>
            <option value="custom">Special order colour</option>
          </select>
          <div class="small-text">
            Need a specific shade? Tell us in the notes – we’ll confirm availability and exact pricing before you pay.
          </div>
        </div>

        <div class="inline-fields">
          <div class="field-group">
            <label for="layerSelect">Layer height</label>
            <select id="layerSelect">
              <option value="0.28">0.28 mm – fast / draft</option>
              <option value="0.20" selected>0.20 mm – standard</option>
              <option value="0.12">0.12 mm – high detail</option>
              <option value="0.08">0.08 mm – ultra fine</option>
            </select>
          </div>
          <div class="field-group">
            <label for="quantityInput">Quantity</label>
            <input id="quantityInput" type="number" min="1" step="1" value="1" />
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 3: SUMMARY & QUOTE -->
    <div>
      <div class="step-title">
        <span class="step-badge">3</span>
        <span>Review your quote</span>
      </div>
      <div class="card">
        <div class="summary-row">
          <span>Base (incl. first 50 g)</span>
          <span id="basePriceDisplay">£19.00</span>
        </div>
        <div class="summary-row">
          <span>Extra weight charge</span>
          <span id="extraWeightDisplay">£0.00</span>
        </div>
        <div class="summary-row">
          <span>Material × layer factors</span>
          <span id="factorsDisplay">× 1.00</span>
        </div>
        <div class="summary-row">
          <span>Colour surcharge</span>
          <span id="colourFeeDisplay">£0.00</span>
        </div>
        <div class="summary-row">
          <span>Quantity</span>
          <span id="quantityDisplay">1</span>
        </div>

        <div class="summary-row total-row">
          <span>Total estimate</span>
          <span id="totalDisplay">£19.00</span>
        </div>

        <button id="quoteButton" class="btn-primary" disabled>
          Get instant quote
        </button>
        <div class="quote-note">
          This is an automatic estimate based on your file and settings.  
          For complex, multi-part or engineering-grade projects, we’ll review the model and confirm the final price with you before starting any print.
        </div>

        <!-- 要和 Wix 表单打通时，可以启用隐藏字段 -->
        <!-- <input type="hidden" id="hiddenQuoteTotal" name="quote_total" /> -->
        <!-- <input type="hidden" id="hiddenWeight"     name="model_weight" /> -->
      </div>
    </div>
  </div>
</div>

<script>
  // ====== INTERNAL PRICING CONFIG（后台规则） ======
  const pricingConfig = {
    basePrice: 19.0,          // 起步价（含前 50g PLA 0.2mm）
    baseWeight: 50,           // g
    extraPricePerGram: 0.20,  // 超出部分每 g 单价（PLA 0.2mm 基准）

    // 材料系数
    materials: {
      PLA: 1.0,
      PETG: 1.25,
      TPU: 1.35,
      PLA_CF: 1.45,
      ASA_ABS: 1.4,
      PC: 1.6,
      PA: 1.8,
      PA_CF: 2.0
    },

    // 层高系数
    layerHeights: {
      "0.28": 0.85,
      "0.20": 1.0,
      "0.12": 1.4,
      "0.08": 1.8
    },

    // 颜色加价（按件）
    colourFees: {
      basic: 0,
      standard: 1.5,
      special: 3.0,
      custom: 4.0
    },

    // 体积转克重系数（cm³ → g），考虑空心 + infill
    volumeToWeightFactor: 0.45
  };

  // ====== STL 体积计算（解析 STL，估算克重） ======
  function signedTetraVolume(p1, p2, p3) {
    return (
      p1.x * (p2.y * p3.z - p2.z * p3.y) -
      p1.y * (p2.x * p3.z - p2.z * p3.x) +
      p1.z * (p2.x * p3.y - p2.y * p3.x)
    ) / 6.0;
  }

  function isBinarySTL(arrayBuffer) {
    if (arrayBuffer.byteLength < 84) return false;
    const dv = new DataView(arrayBuffer);
    const triCount = dv.getUint32(80, true);
    const expectedSize = 84 + triCount * 50;
    return expectedSize === arrayBuffer.byteLength;
  }

  function computeBinarySTLVolume(arrayBuffer) {
    const dv = new DataView(arrayBuffer);
    const triCount = dv.getUint32(80, true);
    let offset = 84;
    let volume = 0;

    for (let i = 0; i < triCount; i++) {
      const ax = dv.getFloat32(offset + 12, true);
      const ay = dv.getFloat32(offset + 16, true);
      const az = dv.getFloat32(offset + 20, true);

      const bx = dv.getFloat32(offset + 24, true);
      const by = dv.getFloat32(offset + 28, true);
      const bz = dv.getFloat32(offset + 32, true);

      const cx = dv.getFloat32(offset + 36, true);
      const cy = dv.getFloat32(offset + 40, true);
      const cz = dv.getFloat32(offset + 44, true);

      const p1 = { x: ax, y: ay, z: az };
      const p2 = { x: bx, y: by, z: bz };
      const p3 = { x: cx, y: cy, z: cz };

      volume += signedTetraVolume(p1, p2, p3);
      offset += 50;
    }

    return Math.abs(volume); // mm³
  }

  function computeAsciiSTLVolume(text) {
    const lines = text.split(/\r?\n/);
    let volume = 0;
    let vertices = [];

    for (let line of lines) {
      line = line.trim();
      if (line.toLowerCase().startsWith('vertex')) {
        const parts = line.split(/\s+/);
        if (parts.length >= 4) {
          const x = parseFloat(parts[1]);
          const y = parseFloat(parts[2]);
          const z = parseFloat(parts[3]);
          if (!isNaN(x) && !isNaN(y) && !isNaN(z)) {
            vertices.push({ x, y, z });
            if (vertices.length === 3) {
              volume += signedTetraVolume(vertices[0], vertices[1], vertices[2]);
              vertices = [];
            }
          }
        }
      }
    }

    return Math.abs(volume); // mm³
  }

  function estimateWeightFromSTL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();

      reader.onload = function (e) {
        try {
          const arrayBuffer = e.target.result;
          if (isBinarySTL(arrayBuffer)) {
            const volMm3 = computeBinarySTLVolume(arrayBuffer);
            const volCm3 = volMm3 / 1000.0;
            const grams = volCm3 * pricingConfig.volumeToWeightFactor;
            resolve(grams);
          } else {
            const readerText = new FileReader();
            readerText.onload = function (e2) {
              try {
                const text = e2.target.result;
                const volMm3 = computeAsciiSTLVolume(text);
                const volCm3 = volMm3 / 1000.0;
                const grams = volCm3 * pricingConfig.volumeToWeightFactor;
                resolve(grams);
              } catch (err) {
                reject(err);
              }
            };
            readerText.onerror = reject;
            readerText.readAsText(file);
          }
        } catch (err) {
          reject(err);
        }
      };

      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  // ====== 报价计算 & UI 绑定 ======
  const fileInput        = document.getElementById('fileInput');
  const materialSelect   = document.getElementById('materialSelect');
  const colourSelect     = document.getElementById('colourSelect');
  const layerSelect      = document.getElementById('layerSelect');
  const quantityInput    = document.getElementById('quantityInput');
  const quoteButton      = document.getElementById('quoteButton');
  const weightWarning    = document.getElementById('weightWarning');
  const weightDisplay    = document.getElementById('weightDisplay');

  const basePriceDisplay   = document.getElementById('basePriceDisplay');
  const extraWeightDisplay = document.getElementById('extraWeightDisplay');
  const factorsDisplay     = document.getElementById('factorsDisplay');
  const colourFeeDisplay   = document.getElementById('colourFeeDisplay');
  const quantityDisplay    = document.getElementById('quantityDisplay');
  const totalDisplay       = document.getElementById('totalDisplay');

  // const hiddenQuoteTotal = document.getElementById('hiddenQuoteTotal');
  // const hiddenWeight     = document.getElementById('hiddenWeight');

  let currentEstimatedWeight = null; // 单个模型克重

  function formatCurrency(value) {
    return '£' + value.toFixed(2);
  }

  function updateQuote() {
    const qtyRaw = parseInt(quantityInput.value, 10);
    const quantity = isNaN(qtyRaw) || qtyRaw < 1 ? 1 : qtyRaw;
    quantityInput.value = quantity;
    quantityDisplay.textContent = quantity;

    if (currentEstimatedWeight === null || currentEstimatedWeight <= 0) {
      weightWarning.style.display = 'block';
      quoteButton.disabled = true;

      const fallbackTotal = pricingConfig.basePrice * quantity;
      basePriceDisplay.textContent   = formatCurrency(pricingConfig.basePrice);
      extraWeightDisplay.textContent = formatCurrency(0);
      factorsDisplay.textContent     = '× 1.00';
      colourFeeDisplay.textContent   = formatCurrency(0);
      totalDisplay.textContent       = formatCurrency(fallbackTotal);
      // if (hiddenQuoteTotal) hiddenQuoteTotal.value = fallbackTotal.toFixed(2);
      return;
    } else {
      weightWarning.style.display = 'none';
      quoteButton.disabled = false;
    }

    const weight = currentEstimatedWeight;
    const extraWeight = Math.max(0, weight - pricingConfig.baseWeight);
    const extraWeightFee = extraWeight * pricingConfig.extraPricePerGram;

    const materialKey = materialSelect.value;
    const layerKey    = layerSelect.value;
    const colourKey   = colourSelect.value;

    const materialFactor = pricingConfig.materials[materialKey] || 1.0;
    const layerFactor    = pricingConfig.layerHeights[layerKey] || 1.0;
    const colourFee      = pricingConfig.colourFees[colourKey] || 0;

    const factorsCombined = materialFactor * layerFactor;

    const basePlusExtra = pricingConfig.basePrice + extraWeightFee;
    const pricePerPart = basePlusExtra * factorsCombined + colourFee;

    const total = pricePerPart * quantity;

    basePriceDisplay.textContent   = formatCurrency(pricingConfig.basePrice);
    extraWeightDisplay.textContent = formatCurrency(extraWeightFee);
    factorsDisplay.textContent     = '× ' + factorsCombined.toFixed(2);
    colourFeeDisplay.textContent   = formatCurrency(colourFee);
    totalDisplay.textContent       = formatCurrency(total);

    // if (hiddenQuoteTotal) hiddenQuoteTotal.value = total.toFixed(2);
  }

  // 文件上传 → 估重 → 报价
  fileInput.addEventListener('change', function () {
    const file = fileInput.files && fileInput.files[0];
    currentEstimatedWeight = null;
    weightDisplay.textContent = '--';
    quoteButton.disabled = true;

    if (!file) {
      updateQuote();
      return;
    }

    const lowerName = file.name.toLowerCase();
    if (!lowerName.endsWith('.stl')) {
      weightWarning.style.display = 'block';
      weightWarning.textContent = 'Automatic weight estimation currently supports STL files only.';
      updateQuote();
      return;
    } else {
      weightWarning.textContent = 'Please upload a valid STL file so we can calculate the weight.';
    }

    estimateWeightFromSTL(file)
      .then(grams => {
        if (!isFinite(grams) || grams <= 0) {
          throw new Error('Invalid weight from STL');
        }
        const rounded = Math.max(1, Math.round(grams));
        currentEstimatedWeight = rounded;
        weightDisplay.textContent = rounded + ' g';
        // if (hiddenWeight) hiddenWeight.value = rounded.toString();
        updateQuote();
      })
      .catch(err => {
        console.error('Weight estimation error:', err);
        currentEstimatedWeight = null;
        weightDisplay.textContent = 'Unable to estimate';
        weightWarning.style.display = 'block';
        weightWarning.textContent = 'We could not read this STL file. Please contact us for a manual quote.';
        updateQuote();
      });
  });

  [materialSelect, colourSelect, layerSelect, quantityInput].forEach(function (el) {
    el.addEventListener('input', updateQuote);
    el.addEventListener('change', updateQuote);
  });

  quoteButton.addEventListener('click', function (e) {
    e.preventDefault();
    updateQuote();
    // 这里可以触发 Wix 表单提交：例如 document.querySelector('#wix-form-button-id')?.click();
  });

  updateQuote();
</script>
</body>
</html>
