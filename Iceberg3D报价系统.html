<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iceberg 3D â€“ Full System</title>
  
  <script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
  </script>

  <style>
    :root { --iceberg-bg: #f4f7fb; --iceberg-card-bg: #ffffff; --iceberg-accent: #1f6b63; --iceberg-accent-soft: #e0f2f0; --iceberg-border: #dde3ee; --iceberg-text-main: #1f2933; --iceberg-text-muted: #6b7280; }
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { margin: 0; padding: 24px 16px 32px; background: var(--iceberg-bg); color: var(--iceberg-text-main); }
    .iceberg-quote-page { max-width: 1120px; margin: 0 auto; }
    .steps { display: grid; grid-template-columns: 2.1fr 2.1fr 1.5fr; gap: 20px; align-items: flex-start; }
    @media (max-width: 960px) { .steps { grid-template-columns: 1fr; } }
    .step-title { display: flex; align-items: center; gap: 8px; font-size: 16px; margin-bottom: 10px; font-weight: 600; }
    .step-badge { width: 22px; height: 22px; border-radius: 999px; background: var(--iceberg-accent); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
    .card { background: var(--iceberg-card-bg); border: 1px solid var(--iceberg-border); border-radius: 14px; padding: 16px 16px 18px; box-shadow: 0 10px 25px rgba(15, 23, 42, 0.04); }
    #viewer-container { width: 100%; height: 240px; background: #f0f3f8; border-radius: 10px; margin-bottom: 16px; position: relative; overflow: hidden; border: 1px solid var(--iceberg-border); }
    #viewer-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--iceberg-text-muted); font-size: 13px; text-align: center; pointer-events: none; }
    canvas { display: block; outline: none; }
    label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.06em; color: #4b5563; }
    .field-group { margin-bottom: 18px; }
    /* File Upload Button Style */
    .custom-file-upload { display: inline-block; width: 100%; padding: 10px 12px; cursor: pointer; background: #fff; border: 1px solid #cfd4dd; border-radius: 10px; text-align: center; font-size: 13px; font-weight: 600; color: var(--iceberg-text-main); transition: all 0.2s; }
    .custom-file-upload:hover { border-color: var(--iceberg-accent); background: #fcfcfc; }
    input[type="file"] { display: none; }
    
    .inline-fields { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .small-text { font-size: 11px; color: var(--iceberg-text-muted); margin-top: 4px; line-height: 1.4; }
    .weight-display-box { padding: 8px 10px; border-radius: 10px; border: 1px dashed #cfd4dd; background: #f9fafb; font-size: 14px; display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .color-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(32px, 1fr)); gap: 10px; margin-top: 8px; }
    .color-swatch-container { position: relative; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
    .color-swatch { width: 32px; height: 32px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; }
    .color-swatch:hover { transform: scale(1.15); box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 10; }
    .color-swatch-container.selected .color-swatch { transform: scale(1.1); box-shadow: 0 0 0 2px white, 0 0 0 4px var(--iceberg-accent); border: none; }
    .selected-color-name { font-size: 12px; font-weight: 600; color: var(--iceberg-accent); margin-top: 6px; min-height: 18px; transition: color 0.2s; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; color: #4b5563; }
    .total-row { border-top: 1px solid var(--iceberg-border); margin-top: 10px; padding-top: 10px; font-size: 17px; font-weight: 700; color: #111827; }
    .btn-primary { width: 100%; margin-top: 12px; padding: 12px 0; border-radius: 999px; border: none; background: var(--iceberg-accent); color: #fff; font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.15s ease, transform 0.08s ease, box-shadow 0.12s ease; box-shadow: 0 8px 18px rgba(31, 107, 99, 0.28); }
    .btn-primary:disabled { background: #c1ccd4; box-shadow: none; cursor: not-allowed; }
    
    /* Loading Overlay */
    #loadingOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:100; flex-direction:column; justify-content:center; align-items:center; font-weight:600; color:var(--iceberg-accent); text-align: center; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--iceberg-accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<!-- Overlay for Uploading Process -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <div id="loadingMsg">Uploading & Creating Order...<br><span style="font-size:12px; font-weight:400; color:#666;">This may take a few seconds.</span></div>
</div>

<div class="iceberg-quote-page">
  <div class="steps">
    <!-- STEP 1: UPLOAD -->
    <div>
      <div class="step-title"><span class="step-badge">1</span><span>Upload model</span></div>
      <div class="card">
        <div class="field-group">
          <label>STL File</label>
          <label for="fileInput" class="custom-file-upload">ðŸ“‚ Select STL File</label>
          <input id="fileInput" type="file" accept=".stl" />
          <div id="fileInfo" style="margin-top:8px; font-size:13px; font-weight:600; color:#1f6b63;"></div>
        </div>
        <div class="field-group">
          <label>Estimated Weight</label>
          <div class="weight-display-box"><div><span class="weight-display-label" style="font-size:11px; color:#888;">TOTAL WEIGHT</span></div><div id="weightDisplay" class="weight-display-value">--</div></div>
        </div>
      </div>
    </div>

    <!-- STEP 2: CONFIG -->
    <div>
      <div class="step-title"><span class="step-badge">2</span><span>Material & Color</span></div>
      <div class="card">
        <div id="viewer-container"><div id="viewer-placeholder">3D Preview</div></div>
        <div class="field-group"><label>Material Series</label><select id="materialSeries"></select><div id="materialDesc" class="small-text" style="color:var(--iceberg-accent);"></div></div>
        <div class="field-group"><label>Color</label><div id="selectedColorName" class="selected-color-name">--</div><div id="colorGrid" class="color-grid"></div></div>
        <div class="inline-fields">
            <div class="field-group"><label>Quality</label><select id="layerSelect"><option value="0.20">Standard (0.20mm)</option><option value="0.12">Detail (0.12mm)</option></select></div>
            <div class="field-group"><label>Quantity</label><input id="quantityInput" type="number" min="1" value="1" /></div>
        </div>
      </div>
    </div>

    <!-- STEP 3: PRICE -->
    <div>
      <div class="step-title"><span class="step-badge">3</span><span>Price</span></div>
      <div class="card">
        <div class="summary-row"><span>Base</span><span id="basePriceDisplay">Â£0.00</span></div>
        <div class="summary-row"><span>Weight</span><span id="extraWeightDisplay">Â£0.00</span></div>
        <div class="summary-row total-row"><span>Total</span><span id="totalDisplay">Â£0.00</span></div>
        <button id="quoteButton" class="btn-primary" disabled>Pay Now</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import * as THREE from 'three';
  import { STLLoader } from 'three/addons/loaders/STLLoader.js';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

  const PRICING = { start: 15.00, included: 40, perGram: 0.15, volFactor: 0.45 };
  const MATERIALS = {
    "PLA Basic": { m: 1.0, d: "Standard", c: [{n:"White",h:"#FFF"},{n:"Black",h:"#000"},{n:"Blue",h:"#00F"},{n:"Red",h:"#F00"}] },
    "PLA Matte": { m: 1.1, d: "Matte Finish", c: [{n:"Matte Black",h:"#222"},{n:"Matte White",h:"#F0F0F0"}] },
    "PETG": { m: 1.25, d: "Stronger", c: [{n:"Black",h:"#111"},{n:"Grey",h:"#888"}] }
  };

  let rawFile = null; // Store the actual File object
  let weight = 0;
  let selectedMat = "PLA Basic"; let selectedCol = MATERIALS["PLA Basic"].c[0];

  const els = {
    fileIn: document.getElementById('fileInput'),
    fileInfo: document.getElementById('fileInfo'),
    weight: document.getElementById('weightDisplay'),
    matSelect: document.getElementById('materialSeries'),
    colorGrid: document.getElementById('colorGrid'),
    colorName: document.getElementById('selectedColorName'),
    qty: document.getElementById('quantityInput'),
    total: document.getElementById('totalDisplay'),
    btn: document.getElementById('quoteButton'),
    loader: document.getElementById('loadingOverlay')
  };

  // 3D Setup
  const scene = new THREE.Scene(); scene.background = new THREE.Color(0xf0f3f8);
  const cam = new THREE.PerspectiveCamera(45, 1, 0.1, 1000); cam.position.set(50,50,50);
  const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
  document.getElementById('viewer-container').appendChild(renderer.domElement);
  const controls = new OrbitControls(cam, renderer.domElement); controls.autoRotate = true;
  scene.add(new THREE.AmbientLight(0xffffff, 0.6)); scene.add(new THREE.DirectionalLight(0xffffff, 0.8));
  let mesh = null;

  function resize() { const c = document.getElementById('viewer-container'); renderer.setSize(c.clientWidth, c.clientHeight); cam.aspect = c.clientWidth/c.clientHeight; cam.updateProjectionMatrix(); }
  window.addEventListener('resize', resize);
  function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, cam); }
  resize(); animate();

  // Initialization
  Object.keys(MATERIALS).forEach(k => els.matSelect.add(new Option(k,k)));
  renderColors();

  // 1. HANDLE FILE SELECTION
  els.fileIn.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if(!file) return;
    
    rawFile = file; // Save for upload later
    els.fileInfo.textContent = file.name;
    
    const r = new FileReader();
    r.onload = (ev) => {
      try {
        const buffer = ev.target.result;
        const vol = computeVolume(buffer);
        weight = (vol/1000.0) * PRICING.volFactor;
        
        // 3D Render
        const loader = new STLLoader(); const geom = loader.parse(buffer);
        geom.center(); geom.computeVertexNormals();
        if(mesh) { scene.remove(mesh); mesh.geometry.dispose(); }
        mesh = new THREE.Mesh(geom, new THREE.MeshStandardMaterial({color:0xcccccc}));
        mesh.rotation.x = -Math.PI/2; scene.add(mesh);
        
        // Camera Fit
        const box = new THREE.Box3().setFromObject(mesh);
        const size = box.getSize(new THREE.Vector3()).length();
        controls.maxDistance = size*5; cam.position.set(size, size, size);
        document.getElementById('viewer-placeholder').style.display = 'none';
        
        updateMaterial(); calcPrice();

      } catch(err) { console.error(err); alert("Invalid STL"); }
    };
    r.readAsArrayBuffer(file);
  });

  // 2. PAY BUTTON -> READ AS BASE64 -> SEND TO WIX
  els.btn.addEventListener('click', () => {
    if(!rawFile) return;
    
    // Show Loading
    els.loader.style.display = 'flex';
    
    // Convert File to Base64 String for transfer
    const reader = new FileReader();
    reader.onload = function(e) {
      const base64String = e.target.result; // This is the data URL
      
      const quoteInfo = {
        totalPrice: parseFloat(els.total.textContent.replace('Â£','')),
        material: selectedMat,
        color: selectedCol.n,
        quantity: els.qty.value
      };

      // Send HUGE message to Wix
      window.parent.postMessage({
        type: 'StartCheckout',
        payload: {
          fileData: base64String, // The actual file content
          fileName: rawFile.name,
          quoteInfo: quoteInfo
        }
      }, '*');
    };
    reader.readAsDataURL(rawFile);
  });

  function computeVolume(ab) {
    const dv=new DataView(ab); const n=dv.getUint32(80,true); let v=0,off=84;
    for(let i=0;i<n;i++){
      const p1={x:dv.getFloat32(off+12,true),y:dv.getFloat32(off+16,true),z:dv.getFloat32(off+20,true)};
      const p2={x:dv.getFloat32(off+24,true),y:dv.getFloat32(off+28,true),z:dv.getFloat32(off+32,true)};
      const p3={x:dv.getFloat32(off+36,true),y:dv.getFloat32(off+40,true),z:dv.getFloat32(off+44,true)};
      v += (p1.x*(p2.y*p3.z-p2.z*p3.y)-p1.y*(p2.x*p3.z-p2.z*p3.x)+p1.z*(p2.x*p3.y-p2.y*p3.x))/6.0;
      off+=50;
    } return Math.abs(v);
  }

  function renderColors() {
    els.colorGrid.innerHTML = '';
    const mat = MATERIALS[selectedMat];
    selectedCol = mat.c[0];
    mat.c.forEach((c, i) => {
      const d = document.createElement('div'); d.className = 'color-swatch-container'+(i===0?' selected':'');
      d.innerHTML = `<div class="color-swatch" style="background:${c.h}; border:${c.h==='#FFF'?'1px solid #ddd':'none'}"></div>`;
      d.onclick = () => { document.querySelectorAll('.color-swatch-container').forEach(e=>e.classList.remove('selected')); d.classList.add('selected'); selectedCol = c; updateMaterial(); calcPrice(); };
      els.colorGrid.appendChild(d);
    });
    updateMaterial(); calcPrice();
  }
  
  function updateMaterial() { els.colorName.textContent = selectedCol.n; if(mesh) mesh.material.color.set(selectedCol.h); }

  function calcPrice() {
    if(weight <= 0) return;
    const qty = parseInt(els.qty.value)||1;
    els.weight.textContent = Math.ceil(weight) + ' g';
    let extra = 0; if(weight > PRICING.included) extra = (weight - PRICING.included) * PRICING.perGram;
    const total = (PRICING.start + extra) * MATERIALS[selectedMat].m * qty;
    
    els.total.textContent = 'Â£'+total.toFixed(2);
    els.btn.disabled = false;
    document.getElementById('basePriceDisplay').textContent = 'Â£'+PRICING.start.toFixed(2);
    document.getElementById('extraWeightDisplay').textContent = 'Â£'+(extra * MATERIALS[selectedMat].m).toFixed(2);
  }

  els.matSelect.addEventListener('change', (e)=>{ selectedMat=e.target.value; renderColors(); });
  els.qty.addEventListener('input', calcPrice);
</script>
</body>
</html>
